# Development docker-compose configuration
# Usage: make dev (or docker compose up)

services:
  # Go backend with Air live reload
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: app
    volumes:
      - .:/app
      - go-modules:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
      - /app/web/node_modules
      - /app/tmp
    ports:
      - "8080:8080"
      - "2525:2525"
    environment:
      APP_ENV: development
      APP_URL: http://localhost:8080
      SMTP_LISTEN_ADDR: ":2525"
      HTTP_LISTEN_ADDR: ":8080"
      DB_DRIVER: sqlite
      DB_DSN: /app/data/mailgress.db
      STORAGE_PATH: /app/data/attachments
    depends_on:
      assets:
        condition: service_started

  # Vite dev server with HMR
  assets:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: assets
    volumes:
      - ./web:/app/web
      - /app/web/node_modules
    ports:
      - "5173:5173"
    environment:
      NODE_ENV: development

volumes:
  go-modules:
  go-build-cache:
